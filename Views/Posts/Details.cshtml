@using System.Reflection.Metadata
@model Post

<div class="row">
    <div class="col-lg-8">
        <!-- Post Card -->
        <div class="card shadow-sm border-0 mb-4 fade-in">
            <div class="card-body p-4">
                <!-- Post Header -->
                <div class="mb-4">
                    <div class="tags mb-3">
                        @foreach (var tag in @Model.Tags)
                        {
                            <a asp-action="Index" asp-route-tag="@tag.Url"
                               class="barge bg-@tag.Color bg-opacity-10 text-@tag.Color mb-2 p-1 fw-bold rounded">
                                <i class="bi bi-tag-fill me-1"></i>@tag.Text
                            </a>
                        }
                    </div>

                    <h1 class="fw-bold mb-3 post-title">
                        @Model.Title
                    </h1>

                    <!-- Post Meta -->
                    <div class="d-flex flex-wrap gap-3 text-muted mb-4">
                        <span class="d-flex align-items-center">
                            <i class="bi bi-calendar-event text-primary me-2"></i>
                            @(Model.PublishedOn?.ToString("d MMMM yyyy") ?? "")
                        </span>
                        <span class="d-flex align-items-center">
                            <i class="bi bi-person-circle text-primary me-2"></i>
                            <a asp-controller="Users" asp-action="Profile" asp-route-username="@Model.User.UserName"
                               class="text-decoration-none fw-semibold">
                                @Model.User.Name
                            </a>
                        </span>
                        <span class="d-flex align-items-center">
                            <i class="bi bi-chat-dots text-primary me-2"></i>
                            @Model.Comments.Count() yorum
                        </span>
                    </div>
                </div>

                <!-- Featured Image -->
                <div class="mb-4">
                    <img src="~/img/@Model.Image" class="img-fluid rounded-3 shadow-sm w-100" 
                         alt="@Model.Title" style="max-height: 500px; object-fit: cover;">
                </div>

                <!-- Post Content -->
                <div class="post-content mb-4">
                    @Html.Raw(@Model.Content)
                </div>

                <!-- Share Buttons -->
                <div class="d-flex gap-2 mb-4">
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-share me-1"></i>Paylaş
                    </button>
                    <button class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-bookmark me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="card shadow-sm border-0 fade-in">
            <div class="card-header bg-transparent border-0 pb-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="fw-bold mb-0">
                        <i class="bi bi-chat-dots text-primary me-2"></i>
                        Yorumlar
                        <span class="badge bg-primary ms-2" id="commentCount">@Model.Comments.Count()</span>
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <!-- Comments List -->
                <div id="comments">
                    @if (Model.Comments.Any())
                    {
                        @foreach (var comment in @Model.Comments)
                        {
                            <div class="comment fade-in">
                                <div class="comment-header">
                                    <img src="~/img/@comment.User.Image" class="avatar" alt="@comment.User.Name">
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <a asp-controller="Users" asp-action="Profile" asp-route-username="@comment.User.UserName"
                                               class="comment-author text-decoration-none">
                                                @comment.User.Name
                                            </a>
                                            <span class="text-muted small">@comment.PublishedOn</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-body">
                                    <p class="mb-0 text-secondary">@comment.Text</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-chat-square-text fs-1 mb-3 d-block"></i>
                            <p>Henüz yorum yapılmamış. İlk yorumu siz yapın!</p>
                        </div>
                    }
                </div>

                <hr class="my-4">

                <!-- Add Comment Form -->
                @if (User.Identity!.IsAuthenticated)
                {
                    <div class="bg-light rounded-3 p-4">
                        <h5 class="fw-bold mb-3">
                            <i class="bi bi-pencil-square text-primary me-2"></i>Yorum Ekle
                        </h5>
                        <form asp-controller="Posts" asp-action="AddComment" method="post" id="commentForm">
                            <input type="hidden" id="PostId" name="PostId" value="@Model.PostId">

                            <div class="mb-3">
                                <textarea name="Text" id="Text" class="form-control" rows="4" 
                                          placeholder="Düşüncelerinizi paylaşın..." required></textarea>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button id="btnYorum" type="submit" class="btn btn-primary">
                                    <i class="bi bi-send me-1"></i>Yorum Yap
                                </button>
                            </div>
                        </form>
                    </div>
                }
                else
                {
                    <div class="text-center py-4 bg-light rounded-3">
                        <i class="bi bi-lock fs-1 text-muted mb-3 d-block"></i>
                        <p class="mb-3">Yorum yapmak için giriş yapmalısınız</p>
                        <a asp-controller="Users" asp-action="Login" class="btn btn-primary">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Giriş Yap
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <vc:tags-menu></vc:tags-menu>
        <vc:new-posts></vc:new-posts>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            $("#btnYorum").click(function () {
                const text = $("#Text").val().trim();
                
                if (!text) {
                    toastr.warning("Lütfen bir yorum yazın.");
                    return false;
                }

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("AddComment")',
                    dataType: 'json',
                    data: {
                        PostId: $("#PostId").val(),
                        Text: text
                    },
                    success: function (yorum) {
                        var date = new Date(yorum.publishedOn);
                        var formattedDate = date.toLocaleDateString('tr-TR', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        // Check if there are no comments yet
                        var emptyState = $("#comments").find('.text-center');
                        if (emptyState.length > 0) {
                            emptyState.remove();
                        }

                        $("#comments").append(
                            `
                            <div class="comment fade-in">
                                <div class="comment-header">
                                    <img src="/img/${yorum.image}" class="avatar" alt="${yorum.name}">
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <a href="/profile/${yorum.userName}" class="comment-author text-decoration-none">
                                                ${yorum.name}
                                            </a>
                                            <span class="text-muted small">${formattedDate}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-body">
                                    <p class="mb-0 text-secondary">${yorum.text}</p>
                                </div>
                            </div>
                            `
                        );

                        $("#Text").val("");
                        
                        var adet = $("#commentCount").text();
                        $("#commentCount").text(parseInt(adet) + 1);

                        toastr.success("Yorumunuz başarıyla eklendi!");
                    },
                    error: function () {
                        toastr.error("Bir hata oluştu. Lütfen tekrar deneyin.");
                    }
                });

                return false;
            });
        });
    </script>
}
